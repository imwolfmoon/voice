<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>گفتار به متن در TinyMCE</title>
  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <textarea id="editor">متن خود را اینجا بنویسید...</textarea>

  <script>
    tinymce.init({
      selector: '#editor',
      directionality: 'rtl',
      language: 'fa',
      height: 500,
      menubar: false,
      plugins: 'code',
      toolbar: 'undo redo | bold italic underline | speech | code',

      setup: function (editor) {
        editor.ui.registry.addButton('speech', {
          text: '🎤 گفتار',
          onAction: function () {
            // ساخت پنجره انتخاب زبان و دکمه استارت
            const dialog = document.createElement('div');
            dialog.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";

            dialog.innerHTML = `
              <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-md text-right">
                <h2 class="text-xl font-bold text-red-600 mb-4">🎙️ تبدیل گفتار به متن</h2>
                <label class="block font-semibold mb-2">انتخاب زبان:</label>
                <select id="speechLang" class="w-full mb-4 p-2 border border-gray-300 rounded">
                  <option value="fa-IR">فارسی</option>
                  <option value="en-US">انگلیسی</option>
                  <option value="ar-SA">عربی</option>
                  <option value="tr-TR">ترکی استانبولی</option>
                  <option value="fr-FR">فرانسوی</option>
                </select>
                <div class="flex justify-between mt-4">
                  <button id="startSpeech" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">🎙️ شروع</button>
                  <button id="closeSpeech" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">بستن</button>
                </div>
              </div>
            `;
            document.body.appendChild(dialog);

            let recognition;
            let recognizing = false;

            function createRecognition(lang) {
              const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
              const r = new SpeechRecognition();
              r.lang = lang;
              r.continuous = true;
              r.interimResults = false;

              r.onresult = (event) => {
                let transcript = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                  if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript + " ";
                  }
                }
                editor.insertContent(transcript);
              };

              r.onerror = (event) => {
                console.error("خطا:", event.error);
              };

              r.onend = () => {
                if (recognizing) r.start();
              };

              return r;
            }

            document.getElementById("startSpeech").addEventListener("click", () => {
              const lang = document.getElementById("speechLang").value;

              if (!recognition) recognition = createRecognition(lang);

              if (recognizing) {
                recognition.stop();
                recognizing = false;
                document.getElementById("startSpeech").textContent = "🎙️ شروع";
              } else {
                recognition = createRecognition(lang); // با زبان جدید
                recognition.start();
                recognizing = true;
                document.getElementById("startSpeech").textContent = "⏹️ توقف";
              }
            });

            document.getElementById("closeSpeech").addEventListener("click", () => {
              if (recognizing && recognition) {
                recognition.stop();
              }
              dialog.remove();
            });
          }
        });
      }
    });
  </script>
</body>
</html>
